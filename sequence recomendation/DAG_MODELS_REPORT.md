## Directed Graph-Based Sequence Models

### 1. DirectedDAGNN
**–î–∞–Ω–Ω—ã–µ.** –ò–∑ `compositionsDAG.json` –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –≤—Å–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Å—Ç—ã–µ –ø—É—Ç–∏ –∫–∞–∂–¥–æ–π –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ (–∏—Å—Ç–æ—á–Ω–∏–∫ ‚Üí —Å—Ç–æ–∫). –ö–∞–∂–¥–∞—è –ø–∞—Ä–∞ *(–∫–æ–Ω—Ç–µ–∫—Å—Ç, —Å–ª–µ–¥—É—é—â–∏–π —Å–µ—Ä–≤–∏—Å)* —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ–±—Ä–∞–∑—Ü–æ–º. –£–∑–ª—ã –∫–æ–¥–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ `service_*` –∏–ª–∏ `table_*`, –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –≥—Ä–∞—Ñ–µ –∫–∞–∂–¥–æ–º—É —É–∑–ª—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–µ–∫—Ç–æ—Ä `[is_service, is_table]`.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞.**
- `Linear(2 ‚Üí H)` + BatchNorm + ReLU.
- –ú–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–∞—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–ø–∞–≥–∞—Ü–∏—è (DirectedAPPNP): —Å–æ–æ–±—â–µ–Ω–∏—è –∏–¥—É—Ç —Ç–æ–ª—å–∫–æ –ø–æ —Ä—ë–±—Ä–∞–º `u‚Üív`, –≤–µ—Å–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ `1/out_degree(u)`, –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è dropout, –∞ hop-wise attention —É—á–∏—Ç—Å—è –≤—ã–±–∏—Ä–∞—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –≥–ª—É–±–∏–Ω—É.
- `Linear(H ‚Üí H/2)` + BatchNorm + ReLU + Dropout.
- `Linear(H/2 ‚Üí |services|)`.

**–û–±—É—á–µ–Ω–∏–µ.** –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—Ä–∞–∑—Ü–∞ –±–µ—Ä—ë–º –ª–æ–≥–∏—Ç—ã —Å—Ç—Ä–æ–∫–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —É–∑–ª—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. Loss ‚Äî cross-entropy, –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä Adam, 50 —ç–ø–æ—Ö. –ú–æ–¥–µ–ª—å –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è –ø–æ accuracy, macro-F1, precision, recall, nDCG.

### 2. DeepDAG (2022-like, per-DAG)
**–î–∞–Ω–Ω—ã–µ.** –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ —Å—Ç—Ä–æ–∏—Ç—Å—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π PyTorch Geometric –≥—Ä–∞—Ñ (—É–∑–ª—ã+—Ä—ë–±—Ä–∞). –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É DAG; train/test split —Ö—Ä–∞–Ω–∏—Ç –∏–Ω–¥–µ–∫—Å –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞.**
- Depth-aware encoder: –ª–∏–Ω–µ–π–Ω–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è `[features || depth_embed] ‚Üí H`, –¥–∞–ª–µ–µ —Å—Ç–µ–∫ self-attention –±–ª–æ–∫–æ–≤ (MultiheadAttention + FFN).
- Hop-level attention (—É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–æ–≤ –±–ª–æ–∫–æ–≤ —Å softmax).
- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä `Linear(H ‚Üí H/2 ‚Üí |services|)` —Å LayerNorm+Dropout.

**–û–±—É—á–µ–Ω–∏–µ.** –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏, –¥–ª—è –∫–∞–∂–¥–æ–π —Å—á–∏—Ç–∞–µ–º loss —Ç–æ–ª—å–∫–æ –ø–æ —É–∑–ª–∞–º, –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö —ç—Ç–æ–π –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏. –≠—Ç–æ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç —Å—Ö–µ–º—É –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ DeepDAG: –º–æ–¥–µ–ª—å ‚Äú–∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è‚Äù –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É DAG. –ù–∞ —Ç–µ—Å—Ç–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø—Ä–æ–≥–æ–Ω—è–µ–º –∫–∞–∂–¥—ã–π –≥—Ä–∞—Ñ –∏ –±–µ—Ä—ë–º logits –Ω—É–∂–Ω—ã—Ö —É–∑–ª–æ–≤.

### 3. DAG-GNN (Yu et al., 2019, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ)
**–î–∞–Ω–Ω—ã–µ.** –¢–æ—Ç –∂–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ, —á—Ç–æ –∏ –¥–ª—è DirectedDAGNN, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä—ë–±–µ—Ä —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞. –ù–∏–∫–∞–∫–∏—Ö learnable mask‚Äô–æ–≤ –Ω–∞ —Ä—ë–±—Ä–∞—Ö.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞.**
- `Linear(2 ‚Üí H)`.
- –ù–µ—Å–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤:
  ```
  parent_msg = Œ£_{parent} h_parent W_parent / out_deg(parent)
  child_msg  = Œ£_{child}  h_child  W_child  / out_deg(child)
  self_msg   = h W_self
  h ‚Üê LayerNorm( h + Dropout( GELU(self_msg + parent_msg + child_msg) ) )
  ```
- –ì–æ–ª–æ–≤–∞ `Linear(H ‚Üí H) ‚Üí GELU ‚Üí Dropout ‚Üí Linear(H ‚Üí |services|)`.

**–û–±—É—á–µ–Ω–∏–µ/–æ—Ü–µ–Ω–∫–∞.** –ò–¥–µ–Ω—Ç–∏—á–Ω—ã DirectedDAGNN, –Ω–æ forward —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–∞–∫ —Ä–æ–¥–∏—Ç–µ–ª–µ–π, —Ç–∞–∫ –∏ –¥–µ—Ç–µ–π, —á—Ç–æ –¥–∞—ë—Ç –±–æ–ª–µ–µ –±–æ–≥–∞—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏ –∂—ë—Å—Ç–∫–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.

### 4. GRU4Rec-DAG (Branch-aware)
**–î–∞–Ω–Ω—ã–µ.** –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∏–∑ –ø—É—Ç–µ–π. –í—Ö–æ–¥ ‚Äî –∏–Ω–¥–µ–∫—Å—ã —É–∑–ª–æ–≤ (padding —Å–ª–µ–≤–∞). –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è:
- `successors[node]` ‚Äî –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã-–¥–µ—Ç–∏ (–¥–ª—è –º–∞—Å–∫–∏ –Ω–∞ –≤—ã—Ö–æ–¥–µ).
- `successor_nodes[node]` ‚Äî –≤—Å–µ –¥–µ—Ç–∏ (service/table) –¥–ª—è –≤–µ—Ç–≤–µ–≤–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞.**
- Embedding `(num_nodes+1, d)`.
- Branch aggregator: –Ω–∞ –∫–∞–∂–¥–æ–º timestep –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Å—Ä–µ–¥–Ω–∏–π embedding –≤—Å–µ—Ö –¥–µ—Ç–µ–π —Ç–µ–∫—É—â–µ–≥–æ —É–∑–ª–∞.
- GRU –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—é `[node_emb_t || branch_emb_t]`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –µ–º—É ‚Äú–≤–∏–¥–µ—Ç—å‚Äù –≤–µ—Ç–≤–ª–µ–Ω–∏—è DAG.
- –í—ã—Ö–æ–¥–Ω–æ–π `Linear(hidden ‚Üí |services|)` + –º–∞—Å–∫–∞, –∑–∞–ø—Ä–µ—â–∞—é—â–∞—è –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã –≤–Ω–µ –∏—Å—Ö–æ–¥—è—â–∏—Ö —Ä—ë–±–µ—Ä.

**–û–±—É—á–µ–Ω–∏–µ.** Cross-entropy –ø–æ–≤–µ—Ä—Ö masked logits, grad clipping. –ù–∞ —Ç–µ—Å—Ç–µ ‚Äî —Ç–µ –∂–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ + –º–∞—Å–∫–∞, –º–µ—Ç—Ä–∏–∫–∏ –∫–∞–∫ —É –≥—Ä–∞—Ñ–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π.

### –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ train/test
1. `extract_paths_from_compositions` —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –ø—É—Ç–∏ `(path, composition_id)`.
2. `create_training_pairs` ‚Üí `(contexts, targets, composition_id_of_sample)`.
3. `train_test_split` –¥–µ–ª–∏—Ç –ø—Ä–∏–º–µ—Ä—ã –Ω–∞ –æ–±—É—á–∞—é—â–∏–µ –∏ —Ç–µ—Å—Ç–æ–≤—ã–µ. –î–ª—è sequential –º–æ–¥–µ–ª–µ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è padded –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –¥–ª–∏–Ω—ã –∏ `last_node_idx`.
4. –ì—Ä–∞—Ñ–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏–Ω–¥–µ–∫—Å—ã —É–∑–ª–æ–≤ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –≥—Ä–∞—Ñ–µ; DeepDAG ‚Äî per-composition –≥—Ä–∞—Ñ—ã; GRU4Rec-DAG ‚Äî sequences + branch info.

### –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- Hidden —Ä–∞–∑–º–µ—Ä GNN: 64.
- Embedding —É–∑–ª–æ–≤ –¥–ª—è GRU: 64; –≤—Ö–æ–¥ GRU = 128 (–∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è).
- GRU hidden = 128, num_layers = 2.
- –ö–æ–ª-–≤–æ –∫–ª–∞—Å—Å–æ–≤ = —á–∏—Å–ª–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ –¥–∞–Ω–Ω—ã—Ö (‚âà15).

### üìà –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 17.11.2025)

–ó–∞–ø—É—Å–∫ –∫–æ–º–∞–Ω–¥—ã:

```bash
python 'sequence recomendation/directed_dag_models.py' \
  --data 'sequence recomendation/compositionsDAG.json' \
  --epochs 200 --hidden 64 --dropout 0.4 --test-size 0.3 --seed 42
```

| –ú–æ–¥–µ–ª—å           | Accuracy | nDCG  | Macro F1 |
|------------------|----------|-------|----------|
| Popularity       | 0.4787   | 0.6597| 0.0539   |
| DirectedDAGNN    | 0.5115   | 0.7534| 0.1138   |
| DeepDAG2022      | 0.5213   | 0.7605| 0.1805   |
| DAG-GNN          | 0.5213   | 0.7571| 0.1805   |
| DAGNN2021        | 0.5213   | 0.7571| 0.1805   |
| GRU4Rec (global) | **0.5410** | **0.7781** | **0.2349** |

–í—Å–µ –º–æ–¥–µ–ª–∏ –æ–±—É—á–µ–Ω—ã –Ω–∞ 1‚ÄØ016 –ø–∞—Ä–∞—Ö *(–∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Üí —Å–ª–µ–¥—É—é—â–∏–π —Å–µ—Ä–≤–∏—Å)*, –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã—Ö –∏–∑ 943 —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π. –ó–Ω–∞—á–µ–Ω–∏—è –æ–∫—Ä—É–≥–ª–µ–Ω—ã –¥–æ 4 –∑–Ω–∞–∫–æ–≤; –ª—É—á—à–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –ø–æ accuracy –∏ nDCG –Ω–∞ —Ç–µ–∫—É—â–µ–º —Å–ø–ª–∏—Ç–µ –ø–æ–∫–∞–∑–∞–Ω–∞ –∂–∏—Ä–Ω—ã–º.


